@page "/shipment/create"
@using Microsoft.AspNetCore.Components.Forms
@using System.Net.Http.Headers
@using CarrierIntegrationWebApp.Services
@rendermode InteractiveServer
@inject HttpClient Http
@inject NavigationManager Navigation
@inject PendingShipmentService PendingShipmentService
@inject BearerTokenService BearerTokenService

<PageTitle>Create Shipment</PageTitle>

<h1>Create Shipment</h1>

@if (!HasValidToken())
{
    <div class="alert alert-warning" role="alert">
        <p>You need to login first to create a shipment.</p>
        <a href="/login" class="btn btn-primary">Go to Login</a>
    </div>
}
else
{
    <div class="row">
        <div class="col-md-6">
            <EditForm Model="@shipmentModel" OnValidSubmit="@HandleCreateShipment">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-3">
                    <label for="carrier" class="form-label">Carrier</label>
                    <InputSelect id="carrier" @bind-Value="shipmentModel.Carrier" class="form-control">
                        <option value="">Select a carrier...</option>
                        <option value="DHL">DHL</option>
                        <option value="FedEx">FedEx</option>
                        <option value="UPS">UPS</option>
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label for="trackingNumber" class="form-label">Tracking Number</label>
                    <InputText id="trackingNumber" @bind-Value="shipmentModel.TrackingNumber" class="form-control" />
                </div>

                <div class="mb-3">
                    <label for="amount" class="form-label">Weight (kg)</label>
                    <InputNumber id="amount" @bind-Value="shipmentModel.Amount" class="form-control" />
                </div>

                <div class="mb-3">
                    <label for="zone" class="form-label">Zone</label>
                    <InputSelect id="zone" @bind-Value="shipmentModel.Zone" class="form-control">
                        <option value="">Select a zone...</option>
                        <option value="NL">NL (Netherlands)</option>
                        <option value="EU">EU (European Union)</option>
                        <option value="INT">INT (International)</option>
                    </InputSelect>
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger" role="alert">
                        <strong>Error:</strong> @errorMessage
                    </div>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="alert alert-success" role="alert">
                        <strong>Success!</strong> @successMessage
                    </div>
                }

                <button type="submit" class="btn btn-primary" disabled="@(isLoading || isSubmittedSuccessfully)">
                    @if (isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    Create Shipment
                </button>
                <button type="button" class="btn btn-secondary ms-2" @onclick="ResetForm" disabled="@(isLoading || !isSubmittedSuccessfully)">
                    Reset
                </button>
            </EditForm>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    public bool? AutoSubmit { get; set; }
    
    private ShipmentModel shipmentModel = new();
    private string? errorMessage;
    private string? successMessage;
    private bool isLoading = false;
    private bool isSubmittedSuccessfully = false;

    protected override void OnInitialized()
    {
        // Check if we should auto-submit after returning from login
        if (AutoSubmit == true && HasValidToken())
        {
            // Restore form data from scoped service (server-side, XSS-safe)
            var pendingData = PendingShipmentService.RetrieveAndClear();
            if (pendingData != null)
            {
                shipmentModel = new ShipmentModel
                {
                    Carrier = pendingData.Carrier,
                    TrackingNumber = pendingData.TrackingNumber,
                    Amount = pendingData.Amount,
                    Zone = pendingData.Zone
                };
                
                // Remove autoSubmit query param from URL
                Navigation.NavigateTo("/shipment/create", true);
            }
        }
    }

    private bool HasValidToken()
    {
        return BearerTokenService.HasToken();
    }

    private async Task HandleCreateShipment()
    {
        isLoading = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            // Create HTTP request with Authorization header
            var request = new HttpRequestMessage(HttpMethod.Post, "https://localhost:7082/shipment/add");
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", BearerTokenService.Token);
            request.Content = JsonContent.Create(new
            {
                shipment = new
                {
                    carrier = shipmentModel.Carrier,
                    trackingNumber = shipmentModel.TrackingNumber,
                    amount = shipmentModel.Amount,
                    zone = shipmentModel.Zone
                }
            });

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ShipmentResponse>();
                if (result != null)
                {
                    isSubmittedSuccessfully = true;

                    if (!string.IsNullOrEmpty(result.TrackingNumber))
                    {
                        successMessage = $"Shipment created successfully! Tracking Number: {result.TrackingNumber}";
                    }
                    else
                    {
                        successMessage = "Shipment created successfully!";
                    }
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                BearerTokenService.RemoveToken();

                // Store form data in scoped service (server-side, XSS-safe)
                PendingShipmentService.StorePendingShipment(
                    shipmentModel.Carrier,
                    shipmentModel.TrackingNumber,
                    shipmentModel.Amount,
                    shipmentModel.Zone
                );
                
                errorMessage = "Unauthorized. Please login again.";
                await Task.Delay(2000);
                Navigation.NavigateTo("/login?returnUrl=/shipment/create?autoSubmit=true", false);
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"Failed to create shipment. Status: {response.StatusCode}. {errorContent}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ResetForm()
    {
        shipmentModel = new();
        isSubmittedSuccessfully = false;
        errorMessage = null;
        successMessage = null;
    }

    private class ShipmentModel
    {
        public string Carrier { get; set; } = "";
        public string TrackingNumber { get; set; } = "";
        public double Amount { get; set; }
        public string Zone { get; set; } = "";
    }

    private class ShipmentResponse
    {
        public string? Id { get; set; }
        public string? Carrier { get; set; }
        public string? TrackingNumber { get; set; }
        public double Amount { get; set; }
        public string? Zone { get; set; }
    }
}
